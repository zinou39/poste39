<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مستخرج معلومات البطاقة الذهبية</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- [جديد] تحميل مكتبة SheetJS (xlsx) لإنشاء ملفات Excel احترافية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            transition: opacity 0.3s ease-in-out;
        }
        .ltr {
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="max-w-6xl w-full bg-white p-8 rounded-xl shadow-lg m-4">
        
        <!-- العنوان -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">مستخرج معلومات البطاقة الذهبية</h1>
            <p class="text-gray-600 mt-2">ارفع صورة أو عدة صور واضحة (حتى 500+ صورة).</p>
        </div>

        <!-- منطقة الرفع -->
        <div class="space-y-4">
            <div>
                <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-2">1. اختر صورة أو عدة صور:</label>
                <!-- السمة "multiple" تسمح باختيار ملفات متعددة -->
                <input type="file" id="imageUpload" accept="image/*" multiple
                       class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                "/>
            </div>

            <!-- معاينة الملفات -->
            <div class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div id="filePreview" class="text-center text-gray-600">
                    لم يتم اختيار أي ملفات
                </div>
            </div>

            <!-- حقول الإدخال -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                <div>
                    <label for="recipientType" class="block text-sm font-medium text-gray-700 mb-2">2. نوع المستلم:</label>
                    <input type="text" id="recipientType" name="recipientType" value="بطاقة ذهبية"
                           class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="counterNumber" class="block text-sm font-medium text-gray-700 mb-2">3. رقم الشباك:</label>
                    <input type="text" id="counterNumber" name="counterNumber" value="4" 
                           class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- زر الاستخراج -->
            <button id="extractButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                4. استخراج المعلومات
            </button>
        </div>

        <!-- مؤشر التحميل -->
        <div id="loader" class="loader hidden"></div>
        <!-- رسالة التقدم -->
        <p id="loaderMessage" class="text-center text-gray-600 mt-2 hidden"></p>

        <!-- قسم النتائج (تم تحويله إلى جدول) -->
        <div id="results" class="mt-6 border-t pt-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">النتائج المستخرجة:</h2>
            
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y-2 divide-gray-200 bg-white text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900 text-right">نوع المستلم</th>
                            <th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900 text-right">رقم الشباك</th>
                            <th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900 text-right">الاسم واللقب</th>
                            <th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900 text-left">رقم الهاتف</th>
                            <th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900 text-left">رقم الحساب (RIB)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="divide-y divide-gray-200">
                        <!-- سيتم حقن الأسطر هنا بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- زر التحميل -->
            <!-- [تعديل] تم تغيير النص ليعكس الصيغة الجديدة .xlsx -->
            <button id="downloadButton" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300 hidden">
                تحميل كملف Excel (.xlsx)
            </button>
        </div>

        <!-- صندوق الرسائل (بديل لـ alert) -->
        <div id="messageBox" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-red-600 text-white py-3 px-6 rounded-lg shadow-xl message-box z-50">
            <span id="messageText"></span>
        </div>

    </div>

    <script>
        // --- متغيرات ---
        const imageUpload = document.getElementById('imageUpload');
        const filePreview = document.getElementById('filePreview');
        const extractButton = document.getElementById('extractButton');
        const loader = document.getElementById('loader');
        const loaderMessage = document.getElementById('loaderMessage');
        const results = document.getElementById('results');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const downloadButton = document.getElementById('downloadButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const recipientType = document.getElementById('recipientType');
        const counterNumber = document.getElementById('counterNumber');

        let uploadedFiles = null; 
        let extractedData = []; 
        const apiKey = ""; // سيتم توفير مفتاح API في بيئة التشغيل
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- تهيئة ---
        extractButton.disabled = true;

        // --- معالجات الأحداث ---

        imageUpload.addEventListener('change', (e) => {
            uploadedFiles = e.target.files; 
            if (!uploadedFiles || uploadedFiles.length === 0) {
                filePreview.textContent = 'لم يتم اختيار أي ملفات';
                extractButton.disabled = true;
                return;
            }

            filePreview.textContent = `${uploadedFiles.length} ملفات مختارة`;
            
            extractButton.disabled = false;
            results.classList.add('hidden'); 
            downloadButton.classList.add('hidden'); 
            resultsTableBody.innerHTML = ''; 
            extractedData = []; 
        });

        // [تعديل] تم تغيير منطق المعالجة إلى تسلسلي (واحد تلو الآخر) لضمان الموثوقية
        extractButton.addEventListener('click', async () => {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                showMessage('الرجاء اختيار ملف واحد على الأقل.');
                return;
            }

            const recipientTypeValue = recipientType.value.trim();
            const counterNumberValue = counterNumber.value.trim();

            loader.classList.remove('hidden');
            loaderMessage.classList.remove('hidden');
            results.classList.remove('hidden'); // إظهار الجدول فوراً
            downloadButton.classList.add('hidden');
            extractButton.disabled = true;
            resultsTableBody.innerHTML = ''; 
            extractedData = []; 

            const allFiles = Array.from(uploadedFiles);
            let processedFileCount = 0;
            const totalFiles = allFiles.length;

            // [تعديل] حلقة لمعالجة الملفات واحد تلو الآخر
            try {
                for (const file of allFiles) {
                    processedFileCount++;
                    loaderMessage.textContent = `جاري معالجة الملف ${processedFileCount} من ${totalFiles} (${file.name})...`;

                    // انتظار اكتمال معالجة الملف الواحد قبل البدء في التالي
                    const result = await processFile(file, recipientTypeValue, counterNumberValue);
                    
                    // الدالة processFile مصممة لإرجاع كائن دائماً (بيانات أو خطأ)
                    extractedData.push(result);
                    appendResultToTable(result, result.isError);
                }
            } catch (error) {
                // هذا للالتقاط أخطاء غير متوقعة في الحلقة نفسها
                console.error("خطأ فادح أثناء حلقة المعالجة:", error);
                loaderMessage.textContent = "حدث خطأ فادح. يرجى إعادة المحاولة.";
                showMessage("حدث خطأ غير متوقع. قد تحتاج لإعادة تحميل الصفحة.");
            }

            loader.classList.add('hidden');
            loaderMessage.textContent = `اكتملت المعالجة! (تم تحليل ${totalFiles} ملف)`;
            extractButton.disabled = false;
            
            if (extractedData.length > 0) {
                downloadButton.classList.remove('hidden');
            }
        });

        // [تعديل] تم استبدال منطق تصدير CSV بالكامل بمنطق XLSX الاحترافي
        downloadButton.addEventListener('click', () => {
            if (!extractedData || extractedData.length === 0) {
                showMessage('لا توجد بيانات للتحميل.');
                return;
            }

            // --- [جديد] منطق تصدير Excel الاحترافي (XLSX) ---
            
            // 1. فلترة البيانات وتنسيقها للعرض (مطابقة للرؤوس)
            const headers = [
                "نوع المستلم", 
                "رقم الشباك", 
                "الاسم واللقب", 
                "رقم الهاتف", 
                "رقم الحساب (RIB)"
            ];

            const dataToExport = extractedData
                .filter(row => !row.isError) // فلترة الأخطاء
                .map(row => ({
                    [headers[0]]: row.recipientType,
                    [headers[1]]: row.counterNumber,
                    [headers[2]]: row.fullName,
                    [headers[3]]: row.phoneNumber,
                    [headers[4]]: row.accountNumber
                }));

            // 2. إنشاء ورقة العمل (Worksheet)
            // استخدام json_to_sheet سيجعل الرؤوس (Headers) عريضة (Bold) تلقائياً
            const ws = XLSX.utils.json_to_sheet(dataToExport, { header: headers });

            // 3. (احترافي) - تحديد عرض الأعمدة تلقائياً
            const cols = headers.map(header => {
                let maxW = header.length; // يبدأ بعرض الرأس
                dataToExport.forEach(row => {
                    const val = row[header];
                    if (val) {
                        const len = String(val).length;
                        if (len > maxW) maxW = len;
                    }
                });
                // إعطاء حد أدنى 15 و 5 هوامش
                return { wch: Math.max(15, maxW + 5) };
            });
            ws['!cols'] = cols;

            // 4. (احترافي) - جعل اتجاه الورقة من اليمين لليسار (RTL)
            ws['!view'] = { rtl: true };

            // 5. إنشاء المصنف (Workbook) وإضافة الورقة إليه
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "البيانات المستخرجة");

            // 6. إنشاء وتنزيل الملف
            const fileName = "Extracted_Card_Info.xlsx";
            XLSX.writeFile(wb, fileName);
            // --- نهاية المنطق الجديد ---
        });

        // --- دوال مساعدة ---

        /**
         * [معدل] دالة معالجة ملف واحد (تم فصلها)
         * هذه الدالة تقوم بمعالجة ملف واحد وإرجاع البيانات أو كائن خطأ
         */
        async function processFile(file, recipientTypeValue, counterNumberValue) {
            try {
                const { base64Data, mimeType } = await readFileAsBase64(file);

                const responseSchema = {
                    type: "OBJECT", 
                    properties: {
                        "fullName": { "type": "STRING", "description": "الاسم الكامل لصاحب الحساب." },
                        "accountNumber": { "type": "STRING", "description": "رقم الحساب (يبدأ بعد '00' وينتهي قبل '*')." },
                        "phoneNumber": { 
                            "type": "STRING", 
                            "description": "ابحث عن رقم الهاتف في الأسفل بجانب 'numero de telephone'. يجب أن يبدأ بـ '06' أو '07' أو '05'. إذا لم تجده، أعد قيمة فارغة ('' أو null)." 
                        }
                    }, 
                    required: ["fullName", "accountNumber"]
                };
                
                const userPrompt = `
أنت خبير في تحليل المستندات البنكية.
من صورة هذا المستند، استخرج المعلومات التالية بدقة، متبعاً هذه القواعد:
1.  **fullName**: الاسم الكامل لصاحب الحساب كما هو مكتوب.
2.  **accountNumber**: هذا هو رقم الحساب. ابحث عن السلسلة الطويلة من الأرقام. يجب أن تبدأ *بعد* أول '00' (إن وجد) وتنتهي *قبل* علامة النجمة '*' (إن وجدت). لا تقم بتضمين '00' أو '*'.
3.  **phoneNumber**: [مهم] ابحث عن رقم الهاتف المكتوب في الأسفل بجانب 'numero de telephone'. يجب أن يبدأ الرقم بـ '06'، '07'، أو '05'. إذا لم تجد رقماً مطابقاً، اترك القيمة فارغة ('' أو null).
أعد البيانات بتنسيق JSON المحدد.`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            { inlineData: { mimeType: mimeType, data: base64Data } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                };

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const data = JSON.parse(jsonText);
                    data.recipientType = recipientTypeValue;
                    data.counterNumber = counterNumberValue;
                    data.isError = false;
                    return data; // إرجاع بيانات النجاح
                } else {
                    throw new Error('لم يتم العثور على محتوى قابل للتحليل.');
                }

            } catch (error) {
                console.error(`Error processing file ${file.name}:`, error);
                // إرجاع كائن خطأ بدلاً من طرح الخطأ
                return {
                    fullName: `خطأ في معالجة (${file.name})`,
                    accountNumber: '---',
                    phoneNumber: '---', 
                    recipientType: recipientTypeValue,
                    counterNumber: counterNumberValue,
                    isError: true
                };
            }
        }


        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error('ملف غير صالح، يجب أن يكون صورة.'));
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    const base64Data = imageUrl.split(',')[1];
                    resolve({ base64Data, mimeType: file.type });
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function appendResultToTable(data, isError = false) {
            const row = document.createElement('tr');
            row.className = isError ? 'bg-red-50 text-red-800' : 'bg-white';
            
            const cellStyle = "whitespace-nowrap px-4 py-2";
            const textStyle = isError ? 'font-medium' : 'text-gray-700';
            const errorTextStyle = isError ? 'text-red-900' : 'text-gray-900';

            row.innerHTML = `
                <td class="${cellStyle} ${textStyle}">${data.recipientType || 'N/A'}</td>
                <td class="${cellStyle} ${textStyle}">${data.counterNumber || 'N/A'}</td>
                <td class="${cellStyle} ${isError ? errorTextStyle : textStyle}">${data.fullName || 'لم يُعثر عليه'}</td>
                <td class="${cellStyle} ${textStyle} ltr">${data.phoneNumber || 'N/A'}</td> 
                <td class="${cellStyle} ${textStyle} ltr">${data.accountNumber || 'لم يُعثر عليه'}</td>
            `;
            resultsTableBody.appendChild(row);
        }

        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if ((response.status === 429 || response.status >= 500) && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay * 2)); // زيادة مدة الانتظار
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay * 2));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

    </script>
</body>
</html>

